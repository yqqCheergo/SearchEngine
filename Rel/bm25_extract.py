# 基于BM25，从query、title、content中提取关键句
import re
import jieba
import numpy as np
from rank_bm25 import BM25Okapi

# 配置参数
MAX_WORDS = 300      # 最大词数限制
BM25_TOP_K = 10      # BM25初筛数量

class KeySentenceExtractor:
    def __init__(self):
        # 预加载jieba分词词典提升速度
        jieba.initialize()
        self.sent2id = dict()
        self.sent_list = []

    def clean_text(self, text):
        """清洗文本：移除HTML标签和特殊字符"""
        text = re.sub(r'<[^>]+>', '', text)      # 去HTML标签
        return text.strip()
    
    def chinese_sent_tokenize(self, text):
        """中文分句优化：处理中英文混合文本"""
        if not text.strip():
            return []
        # 正则表达式：匹配中英文句子结束标点，并避免空匹配
        pattern = re.compile(r'([^。！？；?!.]*[。！？；?!.])', re.UNICODE)
        sentences = pattern.findall(text)
        self.sent_list = [s.strip() for s in sentences if s.strip()]
        for i in range(len(self.sent_list)):
            self.sent2id[self.sent_list[i]] = i

    def hybrid_tokenize(self, text):
        """混合分词：结巴分词 + 英文空格分割"""
        words = []
        for token in jieba.cut(text):
            if re.match(r'^\w+$', token):  # 处理英文单词
                words.extend(token.split())
            else:
                words.append(token)
        return words
    
    def extract(self, title, content, query):
        """主提取流程"""
        # 合并标题和正文
        full_text = f"{title}。{content}" if title else content
        
        # 1. 预处理
        cleaned_text = self.clean_text(full_text)
        self.chinese_sent_tokenize(cleaned_text)
        if not self.sent_list:
            return []
            
        # 2. BM25相关度计算
        tokenized_sentences = [self.hybrid_tokenize(s) for s in self.sent_list]
        bm25 = BM25Okapi(tokenized_sentences)
        query_tokens = self.hybrid_tokenize(query)
        doc_scores = bm25.get_scores(query_tokens)
        
        # 取BM25前K个候选句
        top_indices = np.argsort(doc_scores)[-BM25_TOP_K:][::-1]
        candidates = [(self.sent_list[i], doc_scores[i]) for i in top_indices]
        candidate_texts = [c[0] for c in candidates]
        
        selected_id = []
        total_words = 0
        for sent in candidate_texts:
            word_count = int(len(sent) * 0.9)  
            if total_words + word_count > MAX_WORDS:
                break
            selected_id.append(self.sent2id[sent])
            total_words += word_count

        selected_id = sorted(selected_id)
        final_passage = "".join([self.sent_list[i] for i in selected_id])
        
        self.sent2id = dict()
        self.sent_list = []

        return final_passage


extractor = KeySentenceExtractor()

# 示例
content = """
        胸外科 - 山东大学齐鲁医院科室介绍 山东大学齐鲁医院胸外科最早创建于1952年,经过50多年几代人的不断努力,已发展成为国内胸外科一支很重要的队伍,具有较高的学术影响及显著特色,对山东省胸外科事业的发展作出了很大贡献.2015年以第一名的优异成绩荣获山东省临床重点学科.科室现有医护人员54人,由门诊,病房,监护室及胸外科特检室四个部分组成.搬入华美楼新病区后床位扩展为120张,分为两个病区,胸外科一病房(肺外科),胸外科二病房(食管外科).年住院病人3000余人,年手术量近3000台,年抢救危重疑难病人200余人,平均床位使用率105.6%,年门诊量近24000余人次.人才队伍科室目前有医师23人,教授9人,副教授5人,主治医师8人,住院医师1人,其中博士生导师2人,硕士生导师6人.取得博士学位者19人.泰山学者特聘专家1人,享受国务院政府特殊津贴专家1人,齐鲁卫生与健康杰出青年人才1人,国际食管疾病学会中国分会理事1人,中国医师协会胸外科分会常委1人,中国研究型医院学会胸外科学专业委员会常委1人,中国医疗保健国际交流促进会胸外科分会常委1人,中国研究型医院学会微创外科学专业委员会常委1人,中国医师协会内镜医师分会胸腔镜专业委员会常委1人,山东省研究型医院协会胸外科学分会主任委员1人,山东省腔镜外科质量控制中心胸腔镜学组主任委员1人,山东省疼痛医学会加速康复外科专业委员会主任委员1人,山东省医师协会腔镜外科医师分会胸腔镜委员会主任委员1人,山东省卫生厅及济南市卫生局医疗事故鉴定专家库专家6人,《国家执业医师资格技能考试》山东考区首席考官一人.学科带头人田辉教授是省内知名专家,是胸外科博士生和博士后导师,荣获山东大学齐鲁医学院杰出医学专家,齐鲁医院杰出青年人才;同时荣获山东省科技进步二等奖一项;山东省科技进步三等奖一项;山东省高等学校优秀科研成果一等奖一项;山东省医学科技创新成果三等奖三项.目前主持承担国家自然科学基金课题一项,山东省科技攻关课题一项,山东省自然科学基金课题一项,山东大学博士后基金课题一项,山东省卫生厅科技攻关课题三项,山东大学齐鲁医院课题二项.临床医疗胸外科手术创伤及风险大,专业性强,由于努力创新,手术技术及围手术期处理的提高及改进,对手术指征的不断探索扩大,挽救及延长了患者的生命,提高了患者的生存质量.胸外科有着辉煌的历史,50年代率先在省内开展了食管癌切除,胸内吻合术及肺癌肺叶切除术后,又相继开展了纵隔肿瘤,脓胸,肺及食管良性疾病的手术治疗,对一些复杂,难度很高的手术,如支气管及肺动脉联合袖状切除成形术,结肠上徙喉咽食管成形术等均亦成功施行.近年来,对过去视为手术禁区的病例,如伴有严重糖尿病,高血压,冠心病及陈旧性心肌梗塞,纵隔淋巴结转移,高龄患者的手术也相继成功,手术患者最大年龄为90岁.目前全面开展了以电视胸腔镜为代表的胸外科微创手术,如胸内病变活检术,自发性气胸肺大疱切除术,肺良性病变楔形切除术,肺叶切除术,食管平滑肌瘤摘除术,食管囊肿切除术,纵膈肿瘤切除术,胸腺瘤扩大切除术,胸腹腔镜联合食管癌根治术,剑突下纵隔肿瘤切除术,电子导航支气管镜引导下肺部小结节定位及活检术以及手足汗症交感神经切断术等.积极探索与开拓,全身心的为患者健康服务,是科室不懈的追求.教学科研胸外科每年承担学校本硕博8年制博士,七年制硕士班,医学系六年制英语班,医学系,口腔系,卫生系,护理系本科班,夜大,专修科,护理专科班等课堂授课,临床见习及实习任务.近年来相继建立,健全了集体备课制度,授课前试讲制度,针对实习医师的临床典型病例讨论以及教学查房,讲座等制度.见习学生由专人脱产带教,以确保教学质量.对实习医师尽量满足其分管的床位数和病种,并制订了实习医师12小时负责制细则及目标化管理细则.研究生培养方面,1991年以来共培养硕士生(包括在职攻读学位者)85名,1996年开始招收博士生,已毕业30名,现在读12名.有6名研究生课题及论文获省科委奖励并获山东大学优秀论文奖,进修医师培养方面,建科以来,共接受培养全国各地进修医师500余名,科内定期举行讲座提高其业务水平,其中大多数医师已成为当地医院的业务骨干.同时,科内还根据不同层次学生的需要,编写了教学大纲,教学光盘,教材,讲义等,收到了较好的教学效果.有5名医师获卫生部,山东省及山东大学授予的优秀教师荣誉称号.科内重视科研工作,积极鼓励并支持年轻医师参加课题申报,近5年来承担国家级课题2项,省部级课题8项,院级课题5项,获省科委奖励5项,省卫生厅奖励6项.相继开展了食管癌,肺癌的分子生物学研究,食管支架的研究,心肺联合脏器移植的动物实验研究以及食管,气管代用品的临床及实验研究等,有部分科研成果已逐步应用于临床.5年来,科内主编及参编了包括人民卫生出版社,科学出版社,山东科技出版社,河北科技出版社等出版的著作29部,发表在省级以上刊物上论著50余篇,其中被sci收录的有40余篇,影响因子累积达80余分.学术交流胸外科重视对外学术交流,每年约有20人参加国际,全国及省级学术会议及专题讨论会,科内有5人先后参加了第十届,第十一届亚太地区肿瘤会议,中日肿瘤研讨会,中日胸部肿瘤研讨会,中日胸外专家研究会,胸心外科国际学术会议,国际华人胸肺疾病会议,国际胸心外科研讨会等并发表多篇学术论文.科内有5人曾分别赴美国,加拿大和日本进行短期研修,培训及学术交流.目前,胸外科已制订今后5年的发展规划和目标,除继续发挥本专业的特长和优势外,还准备积极引进一些高,精,尖设备和新技术并应于临床.着手建立胸外科基础与临床研究实验室,促进胸外科在基础与临床研究和检查手段方面与国际接轨,加强横向联系,使科研成果尽快产业化,取得最大的社会效益和经济效益.每年拟邀请国际胸外科专家来科进行短期访问和交流1次,并准备继续派出科内医师到国外进行学习和培训.力争在近几年内将我院胸外科建设成国内一流的现代化科室.设备条件胸外科目前拥有欧林巴斯纤维支气管镜及纤维食管镜各1台,熊1000呼吸机2台,心电监护设备20余台,低温冰箱1台,已引进欧林巴斯电子胃镜及电子支气管镜各一套,胸腔镜手术设备3台,电磁导航支气管镜1台.现积极筹备拟建立胸外科基础与临床研究实验室. 详细》 专家团队 (排名不分先后) 更多》 吴铭生 岳韦名 李希波 赵健 尹秋伟 田辉 杨国涛 吴铭生 岳韦名 李希波 赵健 尹秋伟 田辉 杨国涛 吴铭生 岳韦名 李希波 ~EOF!
        """
title = "胸外科 - 山东大学齐鲁医院科室介绍"
query = "齐鲁医院胸外科专家排名"

# 执行提取
final_passage = extractor.extract(title, content, query)
print("关键句提取结果：", final_passage)